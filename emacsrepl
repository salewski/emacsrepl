#!/bin/sh
# emacsrepl - Interactive CLI REPL for Emacs Lisp

scriptdir=${0%/*}

repl() {
    emacs -Q --batch --load "$scriptdir/utf8-decode.el" --load "$scriptdir/emacsrepl.el"
    pkill -u "$USER" -P "$$" -x od
}

if [[ "$TERM" == dumb || "$TERM" == cons25 || "$TERM" == emacs ]]; then
    emacs -Q --batch --load "$scriptdir/emacsrepl.el"
else
    trap 'stty "$restore"' EXIT

    restore=$(stty -g)
    stty raw -echo opost

    stdbuf -oL od -w1 -An -tx1 -v | repl
fi
